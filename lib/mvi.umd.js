!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["alex-editor"]={})}(this,(function(e){"use strict";var t=Object.defineProperty,n=(e,n,s)=>(((e,n,s)=>{n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[n]=s})(e,"symbol"!=typeof n?n+"":n,s),s);const s="_alex-editor-datas";let i={getAttributes(e){let t={};for(let n of e.attributes)/^on/g.test(n.nodeName)||"style"==n.nodeName||(t[n.nodeName]=n.nodeValue);return t},getStyles(e){let t={};if(e.getAttribute("style")){const n=e.getAttribute("style").split(";").filter((e=>e));for(let e of n){const n=e.split(":"),s=n[0].trim(),i=n[1].trim();t[s]=i}}return t},isObject:e=>!("object"!=typeof e||!e),isEmptyObject(e){return!!this.isObject(e)&&0==Object.keys(e).length},isContains:(e,t)=>e===t||(e.contains?e.contains(t):e.compareDocumentPosition?!!(16&e.compareDocumentPosition(t)):void 0),isElement:(e,t)=>t?e&&(1===e.nodeType||3===e.nodeType)&&e instanceof Node:e&&1===e.nodeType&&e instanceof Node,isWindow:e=>!!(e&&e.constructor&&e.constructor.name)&&"Window"==e.constructor.name,removeData(e,t){if(!(e instanceof Document||this.isElement(e,!0)||this.isWindow(e)))throw new TypeError("The first argument must be an element");let n=e[s]||{};null==t||""===t?e[s]={}:(delete n[t],e[s]=n)},hasData(e,t){if(!(e instanceof Document||this.isElement(e,!0)||this.isWindow(e)))throw new TypeError("The first argument must be an element");if(null==t||""===t)throw new TypeError("The second parameter must be a unique key");return(e[s]||{}).hasOwnProperty(t)},getData(e,t){if(!(e instanceof Document||this.isElement(e,!0)||this.isWindow(e)))throw new TypeError("The first argument must be an element");let n=e[s]||{};return null==t||""===t?n:n[t]},setData(e,t,n){if(!(e instanceof Document||this.isElement(e,!0)||this.isWindow(e)))throw new TypeError("The first argument must be an element");if(null==t||""===t)throw new TypeError("The second parameter must be a unique key");let i=e[s]||{};i[t]=n,e[s]=i},getUniqueKey(){let e=this.getData(window,"data-alex-editor-key")||0;return e++,this.setData(window,"data-alex-editor-key",e),e}};const r=e=>{let t=e.split(/[\s]+/g),n=[];return t.forEach((e=>{let t=e.split("."),s={eventName:t[0]};t.length>1&&(s.guid=t[1]),n.push(s)})),n},o=(e,t,n)=>{let s=dataUtil.get(e,"data-alex-editor-events")||{},r=Object.keys(s),o=r.length;for(let i=0;i<o;i++){let o=r[i];s[o].type==t&&(n?o==t+"_"+n&&(e.removeEventListener(s[o].type,s[o].fn,s[o].options),s[o]=void 0):(e.removeEventListener(s[o].type,s[o].fn,s[o].options),s[o]=void 0))}s=(e=>{let t={};return Object.keys(e).forEach((n=>{e[n]&&(t[n]=e[n])})),t})(s),i.setData(e,"data-alex-editor-events",s)},a={...i,on(e,t,n,s){if(!(e instanceof Document||i.isElement(e)||i.isWindow(e)))throw new TypeError("The first argument must be an element node");if(!t||"string"!=typeof t)throw new TypeError("The second argument must be a string");if(!n||"function"!=typeof n)throw new TypeError("The third argument must be a function");i.isObject(s)||(s={});r(t).forEach((t=>{((e,t,n,s,r)=>{let o=i.getData(e,"data-alex-editor-events")||{};n||(n=i.getData(e,"data-alex-editor-guid")||0,i.setData(e,"data-alex-editor-guid",n+1)),o[n=t+"_"+n]&&o[n].type==t&&e.removeEventListener(t,o[n].fn,o[n].options),e.addEventListener(t,s,r),o[n]={type:t,fn:s,options:r},i.setData(e,"data-alex-editor-events",o)})(e,t.eventName,t.guid,n.bind(e),s)}))},off(e,t){if(!(e instanceof Document||i.isElement(e)||i.isWindow(e)))throw new TypeError("The first argument must be an element node");let n=i.getData(e,"data-alex-editor-events");if(!n)return;if(!t){let t=Object.keys(n),s=t.length;for(let i=0;i<s;i++){let s=t[i];e.removeEventListener(n[s].type,n[s].fn,n[s].options)}return i.removeData(e,"data-alex-editor-eventss"),void i.removeData(e,"data-alex-editor-guid")}r(t).forEach((t=>{o(e,t.eventName,t.guid)}))}},l=class{constructor(e,t,n,s,i){this.key=a.getUniqueKey(),this.type=e,this.parsedom=t,this.marks=n,this.styles=s,this.textContent=i,this.children=null,this.parent=null,this._elm=null}isText(){return"text"==this.type}isBlock(){return"block"==this.type}isInline(){return"inline"==this.type}isClosed(){return"closed"==this.type}isBreak(){return this.isClosed()&&"br"==this.parsedom}isEmpty(){if(this.isText()&&!this.textContent)return!0;if(this.isInline()||this.isBlock()){if(!this.hasChildren())return!0;return this.children.every((e=>!e||e.isEmpty()))}return!1}isRoot(){return!this.parent}isContains(e){return!!this.isEqual(e)||!e.isRoot()&&this.isContains(e.parent)}isEqual(e){return!!l.isElement(e)&&this.key==e.key}hasContains(e){return!!l.isElement(e)&&(this.isContains(e)||e.isContains(this))}hasMarks(){return!!this.marks&&(!!a.isObject&&!a.isEmptyObject(this.marks))}hasStyles(){return!!this.styles&&(!!a.isObject&&!a.isEmptyObject(this.styles))}hasChildren(){return!!Array.isArray(this.children)&&!!this.children.length}clone(e=!0){if("boolean"!=typeof e)throw new Error("The parameter must be a Boolean");let t=new l(this.type,this.parsedom,this.marks,this.styles,this.textContent);return e&&this.hasChildren()&&this.children.forEach((n=>{let s=n.clone(e);t.hasChildren()?t.children.push(s):t.children=[s],s.parent=t})),t}convertToBlock(){if(this.isBlock())throw new Error('This element is already of type "block"');let e=this.clone(!0);this.isText()&&(this.textContent=null),this.type="block",this.parsedom=l.paragraph,this.marks=null,this.styles=null,this.children=[e],e.parent=this}_renderElement(){let e=null;if(this.isText())e=document.createTextNode(this.textContent);else{if(e=document.createElement(this.parsedom),this.hasMarks())for(let t in this.marks)/^on/g.test(t)||"style"==t||e.setAttribute(t,this.marks[t]);if(this.hasStyles())for(let t in this.styles)e.style.setProperty(t,this.styles[t]);if(this.hasChildren())for(let t of this.children){let n=t._renderElement();e.appendChild(n)}}return a.setData(e,"data-alex-editor-key",this.key),this._elm=e,e}static isElement(e){return e instanceof l}static flatElements(e){const t=e=>{let n=[];return e.forEach((e=>{if(n.push(e),e.hasChildren()){let s=t(e.children);n=[...n,...s]}})),n};return t(e)}static _renderRules(e){switch(e.parsedom){case"br":case"img":e.type="closed",e.children=null;break;case"span":e.type="inline"}return e}};let h=l;n(h,"paragraph","p"),n(h,"_formatUnchangeableRules",[function(e){return e.isEmpty()&&(e=null),e},function(e){if(e.hasChildren()){let t=e.children.some((e=>!!e&&e.isBreak())),n=e.children.some((e=>!!e&&!e.isBreak()));t&&n?e.children=e.children.map((e=>e&&e.isBreak()?null:e)):t&&e.children.length>1&&(e.children=[e.children[0]])}return e},function(e){if(e.hasChildren()){e.children.some((e=>!!e&&e.isBlock()))&&e.children.forEach((e=>{e&&!e.isBlock()&&e.convertToBlock()}))}return e}]);class c{constructor(e,t){this.element=e,this.offset=t,this._init()}_init(){this.element.isText()||this.element.hasChildren()&&(this.element.children[this.offset]?(this.element=this.element.children[this.offset],this.offset=0):(this.element=this.element.children[this.offset-1],this.offset=1))}static isPoint(e){return e instanceof c}isEqual(e){return!!c.isPoint(e)&&(this.element.isEqual(e.element)&&this.offset==e.offset)}moveToEnd(e){if(h.isElement(e)&&!e.isEmpty())if(e.isText())this.element=e,this.offset=e.textContent.length;else if(e.isClosed())this.element=e,this.offset=1;else if(e.hasChildren()){const t=h.flatElements(e.children).filter((e=>!e.isEmpty())),n=t.length;this.moveToEnd(t[n-1])}}moveToStart(e){if(h.isElement(e)&&!e.isEmpty())if(e.isText())this.element=e,this.offset=0;else if(e.isClosed())this.element=e,this.offset=0;else if(e.hasChildren()){const t=h.flatElements(e.children).filter((e=>!e.isEmpty()));this.moveToStart(t[0])}}getBlock(){const e=t=>t.isBlock()?t:e(t.parent);return e(this.element)}getInline(){const e=t=>t.isInline()?t:t.isRoot()?null:e(t.parent);return e(this.element)}}class f{constructor(e,t){this.anchor=e,this.focus=t}setCursor(){let e=null,t=null,n=null,s=null;if(this.anchor.element.isClosed()){e=this.anchor.element.parent._elm;const n=this.anchor.element.parent.children.findIndex((e=>this.anchor.element.isEqual(e)));t=1==this.anchor.offset?n+1:n}else e=this.anchor.element._elm,t=this.anchor.offset;if(this.focus.element.isClosed()){n=this.focus.element.parent._elm;const e=this.focus.element.parent.children.findIndex((e=>this.focus.element.isEqual(e)));s=1==this.focus.offset?e+1:e}else n=this.focus.element._elm,s=this.focus.offset;const i=window.getSelection();i.removeAllRanges();const r=document.createRange();r.setStart(e,t),r.setEnd(n,s),i.addRange(r)}}class u{constructor(){this.stacks=[],this.index=-1}push(e,t){this.index<this.stacks.length-1&&(this.stacks.length=this.index+1);const n=e.map((e=>this._cloneElement(e))),s=h.flatElements(n).find((e=>e.key==t.anchor.element.key)),i=h.flatElements(n).find((e=>e.key==t.focus.element.key)),r=new c(s,t.anchor.offset),o=new c(i,t.focus.offset),a=new f(r,o);this.stacks.push({stack:n,range:a}),this.index+=1}get(e){if(-1==e){if(this.index<=0)return null;this.index-=1}else if(1==e){if(this.index>=this.stacks.length-1)return null;this.index+=1}const{stack:t,range:n}=this.stacks[this.index],s=t.map((e=>this._cloneElement(e))),i=h.flatElements(s).find((e=>e.key==n.anchor.element.key)),r=h.flatElements(s).find((e=>e.key==n.focus.element.key)),o=new c(i,n.anchor.offset),a=new c(r,n.focus.offset);return{stack:s,range:new f(o,a)}}_cloneElement(e){const t=new h(e.type,e.parsedom,e.marks,e.styles,e.textContent);return t.key=e.key,e.hasChildren()&&e.children.forEach((e=>{let n=this._cloneElement(e);t.hasChildren()?t.children.push(n):t.children=[n],n.parent=t})),t}}class d{constructor(e,t){if(!a.isElement(e))throw new Error("You must specify a dom container to initialize the editor");if(t=this._formatOptions(t),this.$el=e,this.autofocus=t.autofocus,this.disabled=t.disabled,this.value=t.value,this.renderRules=t.renderRules,this.onChange=t.onChange,this.range=null,this._isInputChinese=!1,this._oldValue=t.value,this.stack=this.parseHtml(this.value),this.history=new u,this.formatElements(),0==this.stack.length){const e=new h("block",h.paragraph,null,null,null),t=new h("closed","br",null,null,null);this.addElementTo(t,e,0),this.stack=[e]}this._initRange(),this.domRender(),this.disabled?this.setDisabled():(this.setEnabled(),this.autofocus&&this.collapseToEnd()),a.on(document,"selectionchange",this._selectionChange.bind(this)),a.on(this.$el,"beforeinput",this._beforeInput.bind(this)),a.on(this.$el,"compositionstart compositionupdate compositionend",this._chineseInputHandler.bind(this)),a.on(this.$el,"keydown",this._keyboardDown.bind(this))}_formatOptions(e){let t={disabled:!1,autofocus:!1,renderRules:null,value:"<p><br></p>",onChange:null};return a.isObject(e)&&("boolean"==typeof e.autofocus&&(t.autofocus=e.autofocus),"boolean"==typeof e.disabled&&(t.disabled=e.disabled),"function"==typeof e.renderRules&&(t.renderRules=e.renderRules),"string"==typeof e.value&&e.value&&(t.value=e.value),"function"==typeof e.onChange&&(t.onChange=e.onChange)),t}_initRange(){const e=this.stack[0],t=new c(e,0),n=new c(e,0);this.range=new f(t,n)}_deleteInSameElement(){if(!this.range.anchor.element.isEqual(this.range.focus.element))return;if(0==this.range.anchor.offset&&0==this.range.focus.offset)return;const e=this.getPreviousElementOfPoint(this.range.anchor),t=this.getNextElementOfPoint(this.range.anchor),n=this.range.anchor.getBlock(),s=this.range.anchor.getInline();if(this.range.anchor.element.isText()){const s=this.range.anchor.element.textContent,i=this.range.anchor.offset==this.range.focus.offset?this.range.anchor.offset-1:this.range.anchor.offset,r=this.range.focus.offset;if(this.range.anchor.element.textContent=s.substring(0,i)+s.substring(r),this.range.anchor.offset==this.range.focus.offset&&(this.range.anchor.offset-=1),this.range.focus.element=this.range.anchor.element,this.range.focus.offset=this.range.anchor.offset,this.range.anchor.element.isEmpty())if(n.isEmpty()){const e=new h("closed","br",null,null,null);this.addElementTo(e,n,0),this.range.anchor.moveToEnd(e),this.range.focus.moveToEnd(e)}else e&&n.isContains(e)?(this.range.anchor.moveToEnd(e),this.range.focus.moveToEnd(e)):t&&n.isContains(t)&&(this.range.anchor.moveToStart(t),this.range.focus.moveToStart(t))}else{const i=this.range.anchor.element.parent.children.findIndex((e=>this.range.anchor.element.isEqual(e)));if(this.range.anchor.element.parent.children.splice(i,1),n.isEmpty())if(this.range.anchor.element.isBreak()&&e)this.range.anchor.moveToEnd(e),this.range.focus.moveToEnd(e);else{const e=new h("closed","br",null,null,null);this.addElementTo(e,n,0),this.range.anchor.moveToEnd(e),this.range.focus.moveToEnd(e)}else{const i=this.range.anchor.element.isBreak();e&&n.isContains(e)?(this.range.anchor.moveToEnd(e),this.range.focus.moveToEnd(e)):t&&n.isContains(t)&&(this.range.anchor.moveToStart(t),this.range.focus.moveToStart(t)),s&&s.isEmpty()&&i&&this.delete()}}}_selectionChange(){if(this.disabled)return;if(this._isInputChinese)return;const e=window.getSelection();if(e.rangeCount){const t=e.getRangeAt(0);if(a.isContains(this.$el,t.startContainer)&&a.isContains(this.$el,t.endContainer)){const e=a.getData(t.startContainer,"data-alex-editor-key"),n=a.getData(t.endContainer,"data-alex-editor-key"),s=this.getElementByKey(e),i=this.getElementByKey(n),r=new c(s,t.startOffset),o=new c(i,t.endOffset);this.range=new f(r,o)}}}_beforeInput(e){if(e.preventDefault(),"insertCompositionText"!=e.inputType){switch(e.inputType){case"insertText":this.insertText(e.data);break;case"deleteContentBackward":case"deleteByCut":this.delete();break;case"insertParagraph":this.insertParagraph();break;case"insertFromPaste":e.dataTransfer.getData("text/html"),e.dataTransfer.files}this.formatElements(),this.domRender(),this.range.setCursor()}}_chineseInputHandler(e){e.preventDefault(),"compositionstart"==e.type&&(this._isInputChinese=!0),"compositionend"==e.type&&(this._isInputChinese=!1,this.insertText(e.data),this.formatElements(),this.domRender(),this.range.setCursor())}_keyboardDown(e){if(9===e.keyCode)e.preventDefault()}formatElements(){const e=t=>(t.hasChildren()&&(t.children=t.children.map(e)),h._formatUnchangeableRules.forEach((e=>{t&&(t=e(t))})),t),t=e=>(e&&e.hasChildren()&&(e.children.forEach((e=>{e&&(e=t(e))})),e.children=e.children.filter((e=>!!e))),e);this.stack=this.stack.map((n=>(n.isBlock()||n.convertToBlock(),n=e(n),n=t(n)))).filter((e=>!!e))}domRender(e=!1){this.$el.innerHTML="",this.stack.forEach((e=>{let t=e._renderElement();this.$el.appendChild(t)})),this._oldValue=this.value,this.value=this.$el.innerHTML,this._oldValue!=this.value&&("function"==typeof this.onChange&&this.onChange.apply(this,[this.value,this._oldValue]),e||this.history.push(this.stack,this.range))}setDisabled(){this.disabled=!0,this.$el.removeAttribute("contenteditable")}setEnabled(){this.disabled=!1,this.$el.setAttribute("contenteditable",!0)}getPreviousElement(e){if(!h.isElement(e))throw new Error("The argument must be an AlexElement instance");if(e.isRoot()){const t=this.stack.findIndex((t=>e.isEqual(t)));return t<=0?null:this.stack[t-1].isEmpty()?this.getPreviousElement(this.stack[t-1]):this.stack[t-1]}{const t=e.parent.children.findIndex((t=>e.isEqual(t)));return t<=0?null:e.parent.children[t-1].isEmpty()?this.getPreviousElement(e.parent.children[t-1]):e.parent.children[t-1]}}getNextElement(e){if(!h.isElement(e))throw new Error("The argument must be an AlexElement instance");if(e.isRoot()){const t=this.stack.findIndex((t=>e.isEqual(t)));return t>=this.stack.length-1?null:this.stack[t+1].isEmpty()?this.getNextElement(this.stack[t+1]):this.stack[t+1]}{const t=e.parent.children.findIndex((t=>e.isEqual(t)));return t>=e.parent.children.length-1?null:e.parent.children[t+1].isEmpty()?this.getNextElement(e.parent.children[t+1]):e.parent.children[t+1]}}addElementTo(e,t,n){if(!h.isElement(e))throw new Error("The first argument must be an AlexElement instance");if(!h.isElement(t))throw new Error("The second argument must be an AlexElement instance");if("number"!=typeof n||isNaN(n)||n<0)throw new Error("The third argument must be an integer not less than 0");if(t.isClosed()||t.isText())throw new Error('Elements of type "closed" and "text" cannot have children');if(e.isBlock()&&!t.isBlock())throw new Error("A block element cannot be added to an element that is not a block");t.hasChildren()?n>=t.children.length?t.children.push(e):t.children.splice(n,0,e):t.children=[e],e.parent=t}addElementBefore(e,t){if(!h.isElement(e))throw new Error("The first argument must be an AlexElement instance");if(!h.isElement(t))throw new Error("The second argument must be an AlexElement instance");if(t.isRoot()){const n=this.stack.findIndex((e=>t.isEqual(e)));this.stack.splice(n,0,e),e.parent=null}else{const n=t.parent.children.findIndex((e=>t.isEqual(e)));this.addElementTo(e,t.parent,n)}}addElementAfter(e,t){if(!h.isElement(e))throw new Error("The first argument must be an AlexElement instance");if(!h.isElement(t))throw new Error("The second argument must be an AlexElement instance");if(t.isRoot()){const n=this.stack.findIndex((e=>t.isEqual(e)));n>=this.stack.length-1?this.stack.push(e):this.stack.splice(n+1,0,e),e.parent=null}else{const n=t.parent.children.findIndex((e=>t.isEqual(e)));this.addElementTo(e,t.parent,n+1)}}mergeBlockElement(e){if(!h.isElement(e))throw new Error("The argument must be an AlexElement instance");if(!e.isBlock())throw new Error('Elements that are not "block" cannot be merged');const t=this.getPreviousElement(e);if(t)if(t.children.push(...e.children),t.children.forEach((e=>{e.parent=t})),e.isRoot()){const t=this.stack.findIndex((t=>e.isEqual(t)));this.stack.splice(t,1)}else{const t=e.parent.children.findIndex((t=>e.isEqual(t)));e.parent.children.splice(t,1)}else if(!e.isRoot()){e.parent.children.push(...e.children),e.parent.children.forEach((t=>{t.parent=e.parent}));const t=e.parent.children.findIndex((t=>e.isEqual(t)));e.parent.children.splice(t,1)}}getElementByKey(e){if(!e)throw new Error("You need to specify a key to do the query");const t=n=>{let s=null;for(let i of n){if(i.key==e){s=i;break}if(i.hasChildren()&&(s=t(i.children),s))break}return s};return t(this.stack)}parseNode(e){if(!e)throw new Error("You need to give a node to convert");if(!a.isElement(e,!0))return null;if(3==e.nodeType){let t=new h("text",null,null,null,e.nodeValue);return t=h._renderRules(t),"function"==typeof this.renderRules&&(t=this.renderRules(t)),t}{const t=a.getAttributes(e),n=a.getStyles(e);let s=new h("block",e.nodeName.toLocaleLowerCase(),t,n,null);return s=h._renderRules(s),"function"==typeof this.renderRules&&(s=this.renderRules(s)),Array.from(e.childNodes).forEach((e=>{const t=this.parseNode(e);t&&(t.parent=s,s.hasChildren()?s.children.push(t):s.children=[t])})),s}}parseHtml(e){if(!e)throw new Error("You need to give an html content to convert");const t=document.createElement("div");t.innerHTML=e;let n=[];return Array.from(t.childNodes).forEach((e=>{const t=this.parseNode(e);n.push(t)})),n}getPreviousElementOfPoint(e){if(!c.isPoint(e))throw new Error("The argument must be an AlexPoint instance");const t=h.flatElements(this.stack),n=e=>{const s=t.findIndex((t=>e.isEqual(t)));if(s<=0)return null;let i=t[s-1];return!i.isText()&&!i.isClosed()||i.isEmpty()?n(i):i};return n(e.element)}getNextElementOfPoint(e){if(!c.isPoint(e))throw new Error("The argument must be an AlexPoint instance");const t=h.flatElements(this.stack),n=e=>{const s=t.findIndex((t=>e.isEqual(t)));if(s==t.length-1)return null;let i=t[s+1];return!i.isText()&&!i.isClosed()||i.isEmpty()?n(i):i};return n(e.element)}getElementsByRange(){if(this.range.anchor.isEqual(this.range.focus))return[];let e=[];if(this.range.anchor.element.isEqual(this.range.focus.element))if(this.range.anchor.element.isText()){let t=this.range.anchor.element.textContent;this.range.anchor.element.textContent=t.substring(0,this.range.anchor.offset);let n=new h("text",null,null,null,t.substring(this.range.anchor.offset,this.range.focus.offset));this.addElementAfter(n,this.range.anchor.element);let s=new h("text",null,null,null,t.substring(this.range.focus.offset));this.addElementAfter(s,n),this.range.anchor.moveToStart(n),this.range.focus.moveToEnd(n),e=[n]}else e=[this.range.anchor.element];else{const t=h.flatElements(this.stack),n=t.findIndex((e=>this.range.anchor.element.isEqual(e))),s=t.findIndex((e=>this.range.focus.element.isEqual(e)));for(let i=n+1;i<s;i++)t[i].hasContains(this.range.anchor.element)||t[i].hasContains(this.range.focus.element)||e.push(t[i]);if(this.range.anchor.element.isText()){let t=this.range.anchor.element.textContent;this.range.anchor.element.textContent=t.substring(0,this.range.anchor.offset);let n=new h("text",null,null,null,t.substring(this.range.anchor.offset));this.addElementAfter(n,this.range.anchor.element),e.unshift(n)}else 0==this.range.anchor.offset&&e.unshift(this.range.anchor.element);if(this.range.focus.element.isText()){let t=this.range.focus.element.textContent;this.range.focus.element.textContent=t.substring(0,this.range.focus.offset);let n=new h("text",null,null,null,t.substring(this.range.focus.offset));this.addElementAfter(n,this.range.focus.element),e.push(this.range.focus.element)}else e.push(this.range.focus.element)}return e}delete(){if(this.range.anchor.isEqual(this.range.focus)){const e=this.getPreviousElementOfPoint(this.range.anchor),t=this.range.anchor.getBlock();0==this.range.anchor.offset?e&&(t.isContains(e)?(this.range.anchor.moveToEnd(e),this.range.focus.moveToEnd(e),this._deleteInSameElement()):(this.mergeBlockElement(t),this.range.anchor.moveToEnd(e),this.range.focus.moveToEnd(e))):this._deleteInSameElement()}else if(this.range.anchor.element.isEqual(this.range.focus.element))this._deleteInSameElement();else{const e=h.flatElements(this.stack),t=e.findIndex((e=>this.range.anchor.element.isEqual(e))),n=e.findIndex((e=>this.range.focus.element.isEqual(e)));let s=[];for(let h=t+1;h<n;h++)e[h].hasContains(this.range.anchor.element)||e[h].hasContains(this.range.focus.element)||s.push(e[h]);s.forEach((e=>{if(e.isText())e.textContent="";else if(e.isClosed()){const t=e.parent.children.findIndex((t=>e.isEqual(t)));e.parent.children.splice(t,1)}e.hasChildren()&&(e.children=[])}));const i=this.range.focus.getBlock();let r=!i.hasContains(this.range.anchor.element),o=this.range.focus.element,a=this.range.focus.offset,l=this.range.anchor.element,c=this.range.anchor.offset;this.range.anchor.element=o,this.range.anchor.offset=0,this._deleteInSameElement(),this.range.anchor.element=l,this.range.anchor.offset=c,this.range.focus.element=o,this.range.focus.offset=a,this.range.focus.element=l,this.range.focus.offset=this.range.anchor.element.isText()?this.range.anchor.element.textContent.length:1,this._deleteInSameElement(),r&&this.mergeBlockElement(i)}}insertText(e){if(!e||"string"!=typeof e)throw new Error("The argument must be a string");if(e=e.replace(/\s+/g,(()=>{const e=document.createElement("span");return e.innerHTML="&nbsp;",e.innerText})),this.range.anchor.isEqual(this.range.focus))if(this.range.anchor.element.isText()){let t=this.range.anchor.element.textContent;this.range.anchor.element.textContent=t.substring(0,this.range.anchor.offset)+e+t.substring(this.range.anchor.offset),this.range.anchor.offset=this.range.anchor.offset+e.length,this.range.focus.offset=this.range.anchor.offset}else{const t=new h("text",null,null,null,e);0==this.range.anchor.offset?this.addElementBefore(t,this.range.anchor.element):this.addElementAfter(t,this.range.anchor.element),this.range.anchor.moveToEnd(t),this.range.focus.moveToEnd(t)}else this.delete(),this.insertText(e)}insertParagraph(){if(this.range.anchor.isEqual(this.range.focus)){const e=this.getPreviousElementOfPoint(this.range.anchor),t=this.getNextElementOfPoint(this.range.anchor),n=this.range.anchor.getBlock(),s=this.range.anchor.element.isText()?this.range.anchor.element.textContent.length:1;if(0!=this.range.anchor.offset||e&&n.isContains(e))if(this.range.anchor.offset!=s||t&&n.isContains(t)){const e=this.range.anchor.getBlock(),t=e.clone(!0);this.addElementAfter(t,e),this.range.focus.moveToEnd(e),this.delete();const n=h.flatElements(e.children).findIndex((e=>this.range.anchor.element.isEqual(e))),s=h.flatElements(t.children);this.range.focus.element=s[n],this.range.focus.offset=this.range.anchor.offset,this.range.anchor.moveToStart(t),this.delete()}else{const e=new h("block",n.parsedom,null,null,null),t=new h("closed","br",null,null,null);this.addElementTo(t,e,0),this.addElementAfter(e,n),this.range.anchor.moveToStart(e),this.range.focus.moveToStart(e)}else{const e=new h("block",n.parsedom,null,null,null),t=new h("closed","br",null,null,null);this.addElementTo(t,e,0),this.addElementBefore(e,n),this.range.anchor.moveToStart(n),this.range.focus.moveToStart(n)}}else this.delete(),this.insertParagraph()}collapseToStart(e){if(h.isElement(e))this.range.anchor.moveToStart(e),this.range.focus.moveToStart(e),this.range.setCursor();else{const e=h.flatElements(this.stack);this.collapseToStart(e[0])}}collapseToEnd(e){if(h.isElement(e))this.range.anchor.moveToEnd(e),this.range.focus.moveToEnd(e),this.range.setCursor();else{const e=h.flatElements(this.stack),t=e.length;this.collapseToEnd(e[t-1])}}setStyle(e){if(!a.isObject)throw new Error("The argument must be an object");const t=this.getElementsByRange();t.forEach((t=>{if(t.isText()){let n=t.clone();t.type="inline",t.parsedom="span",t.textContent=null;for(let s in e)t.hasStyles()||(t.styles={}),t.styles[s]=e[s];this.addElementTo(n,t,0)}})),this.range.anchor.moveToStart(t[0]),this.range.focus.moveToEnd(t[t.length-1])}insertElement(e){if(!h.isElement(e))throw new Error("The argument must be an AlexElement instance");if(this.range.anchor.isEqual(this.range.focus)){if(e.isBlock()){const t=this.getPreviousElementOfPoint(this.range.anchor),n=this.getNextElementOfPoint(this.range.anchor),s=this.range.anchor.getBlock(),i=this.range.anchor.element.isText()?this.range.anchor.element.textContent.length:1;if(0!=this.range.anchor.offset||t&&s.isContains(t))if(this.range.anchor.offset!=i||n&&s.isContains(n)){const t=this.range.anchor.getBlock(),n=t.clone(!0);this.addElementAfter(n,t),this.range.focus.moveToEnd(t),this.delete();const s=h.flatElements(t.children).findIndex((e=>this.range.anchor.element.isEqual(e))),i=h.flatElements(n.children);this.range.focus.element=i[s],this.range.focus.offset=this.range.anchor.offset,this.range.anchor.moveToStart(n),this.delete(),this.addElementBefore(e,n)}else this.addElementAfter(e,s);else this.addElementBefore(e,s)}else if(this.range.anchor.element.isText()){let t=this.range.anchor.element.textContent;this.range.anchor.element.textContent=t.substring(0,this.range.anchor.offset);let n=new h("text",null,null,null,t.substring(this.range.anchor.offset));this.addElementAfter(n,this.range.anchor.element),this.addElementBefore(e,n)}else 0==this.range.anchor.offset?this.addElementBefore(e,this.range.anchor.element):this.addElementAfter(e,this.range.anchor.element);this.range.anchor.moveToEnd(e),this.range.focus.moveToEnd(e)}else this.delete(),this.insertElement(e)}}e.AlexEditor=d,e.AlexElement=h,e.default=d,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
